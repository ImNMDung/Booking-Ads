@using BookingAds.Constants
@using BookingAds.Modules
@using BookingAds.Entities
@model BookingAds.Areas.Admin.Models.ManageOrder.ViewManageOrder
@{
    Layout = null;
}

<table id="mytable" class="table table-striped table-bordered" style="">
    <tr>
        @*<th><input type="checkbox" id="checkall" /></th>*@
        <th>Họ và tên khách hàng</th>
        <th>Tên quảng cáo</th>
        <th>Ngày đặt đơn</th>
        <th>Trạng thái đơn</th>
        <th>Hình thức thanh toán</th>
        <th>Số tiền phải trả</th>
        <th colspan="3" class="text-center">Chức năng</th>
    </tr>
    <tbody id="tbBodyOrder">
        @if (Model.Data.Count == 0
            || !DateTimeUtils.IsValidDateTimeSQL(Model.FromDatetime)
            || !DateTimeUtils.IsValidDateTimeSQL(Model.ToDatetime))
        {
            <tr>
                <td colspan="8" class="text-danger text-center" style="font-weight: bold">Không có đơn nào</td>
            </tr>
        }
        @foreach (var order in Model.Data)
        {
            var orderJson = ConvertUtils<Order>.Serialize(order);
            var canceled = OrderStatus.CANCELED.Code.ToString();
            var orderedTime = string.Format("{0:dd/MM/yyyy HH:mm:ss tt}", order.OrderedTime);
            var payType = order.Type == PayTypeConstant.CASH ? "Tiền mặt" : "Ví điện tử";
            var formatStatus = @StatusType.ToFormat(order.Status);
            var status = @StatusType.ToMessage(order.Status);
            var totalMoney = order.TotalMoney.ToString("C", System.Globalization.CultureInfo.GetCultureInfo("vi-VN"));

            <tr>
                @*<td><input type="checkbox" class="checkthis" id="@item.EmployeeID" /></td>*@
                <td>@order.Employee.LastName @order.Employee.FirstName</td>
                <td id="productName-@order.OrderID">@order.Product.ProductName ( @order.CatelogProduct.CatelogName )</td>
                <td>@orderedTime</td>
                <td id="status-@order.OrderID" class=@formatStatus> <b> @status </b></td>
                <td>@payType</td>
                <td id="productPrice-@order.OrderID">
                    @totalMoney
                </td>

                <td>
                    <div id="dropdown-@order.OrderID" class="dropdown">
                        <button style="width:100%" class="btn btn-primary dropdown-toggle
                                @((order.Status == OrderStatus.CANCELED.Code
                                    || order.Status == OrderStatus.REJECTED.Code
                                    || order.Status == OrderStatus.SUCCESSED.Code
                                    || order.Status == OrderStatus.FAILED.Code)
                                ? "disabled" : "")"
                                type="button" id="btnProcessOrder"
                                data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            <span>Xử lý đơn</span>
                            <span class="caret"></span>
                        </button>
                        <ul id="btnAction-@order.OrderID" class="dropdown-menu" aria-labelledby="btnProcessOrder">
                            @if (order.Status == OrderStatus.PENDING.Code)
                            {
                                <li class="btnActionOrder"
                                    data-nextStatus="@OrderStatus.WAITING.Code"
                                    data-url="/Admin/ManageOrder/Approve">
                                    <a style="color: green !important;" href="#" data-toggle="modal" data-target="#process-@order.OrderID">
                                        Phê duyệt
                                    </a>
                                </li>
                            }
                            @if (order.Status == OrderStatus.WAITING.Code)
                            {
                                <li class="btnActionOrder"
                                    data-nextStatus="@OrderStatus.PAYING.Code"
                                    data-url="/Admin/ManageOrder/AcceptGotProduct">
                                    <a style="color: green !important;" href="#" data-toggle="modal" data-target="#sucsess-@order.OrderID">
                                        Xác nhận lấy đơn
                                    </a>
                                </li>
                            }
                            @if (order.Status == OrderStatus.PAYING.Code)
                            {
                                <li class="btnActionOrder"
                                    data-nextStatus="@OrderStatus.SUCCESSED.Code"
                                    data-url="/Admin/ManageOrder/AcceptPayed">
                                    <a style="color: green !important;" href="#" data-toggle="modal" data-target="#sucsess-@order.OrderID">
                                        Xác nhận đã thanh toán
                                    </a>
                                </li>
                            }
                            <li role="separator" class="divider"></li>
                            @if (order.Status == OrderStatus.PENDING.Code)
                            {
                                <li class="btnActionOrder"
                                    data-nextStatus="@OrderStatus.REJECTED.Code"
                                    data-url="/Admin/ManageOrder/Reject">
                                    <a style="color: red !important;" href="#" data-toggle="modal" data-target="#process-@order.OrderID">
                                        Từ chối
                                    </a>
                                </li>
                            }
                            @if (order.Status == OrderStatus.PAYING.Code)
                            {
                                <li class="btnActionOrder"
                                    data-nextStatus="@OrderStatus.FAILED.Code"
                                    data-url="/Admin/ManageOrder/AcceptNotPayed">
                                    <a style="color: red !important;" href="#" data-toggle="modal" data-target="#process-@order.OrderID">
                                        Xác nhận không thanh toán
                                    </a>
                                </li>
                            }
                        </ul>
                        @*}*@
                    </div>
                </td>
                <td class="text-center">
                    <p data-placement="top" data-toggle="tooltip" title="Xóa vĩnh viễn">
                        <button class="btn btn-danger btn-xs @((order.Status == OrderStatus.CANCELED.Code
                                    || order.Status == OrderStatus.REJECTED.Code)
                                ? "" : "disabled")" data-toggle="modal"
                                data-target="@((order.Status == OrderStatus.CANCELED.Code || order.Status == OrderStatus.REJECTED.Code)
                                ? $"#delete-{order.OrderID}" : "")">
                            <span class="glyphicon glyphicon-trash"></span>
                        </button>
                    </p>
                </td>
            </tr>


            @*Model Process*@
            <div class="modal fade" id="process-@order.OrderID" tabindex="-1" role="dialog" aria-labelledby="edit" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content" style="border-radius: 10px;">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                                <span class="glyphicon glyphicon-remove" aria-hidden="true"></span>
                            </button>
                            <h4 class="modal-title custom_align" id="Heading">Xử lý đơn đặt của khách hàng</h4>
                        </div>
                        <div class="modal-body alert alert-info" style="margin-bottom: 0px;">
                            <strong>
                                <i class="glyphicon glyphicon-info-sign"></i>
                            </strong>
                            Bạn có chắc chắn <span class="actionNameOrder"></span> với đơn này không?
                        </div>
                        <div class="modal-footer">
                            <button id="btnProcessOrder-@order.OrderID" type="button" class="btnProcessOrder btn btn-success"
                                    data-id="@order.OrderID"
                                    data-employeeUserName="@order.Employee.UserName"
                                    data-productName="@order.Product.ProductName"
                                    data-orderedTime="@order.OrderedTime"
                                    data-payType="@order.Type"
                                    data-textlink="@order.Textlink"
                                    data-productPrice="@order.Product.Price"
                                    data-action=""
                                    data-url=""
                                    data-nextStatus=""
                                    data-dismiss="modal">
                                <span class="glyphicon glyphicon-ok-sign"></span> Đồng ý
                            </button>
                            <button type="button" class="btn btn-default" data-dismiss="modal">
                                <span class="glyphicon glyphicon-remove"></span>
                                Từ chối
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            @*Model Sucsess*@
            <div class="modal fade" id="sucsess-@order.OrderID" tabindex="-1" role="dialog" aria-labelledby="edit" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content" style="border-radius: 10px;">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                                <span class="glyphicon glyphicon-remove" aria-hidden="true"></span>
                            </button>
                            <h4 class="modal-title custom_align" id="Heading">Xử lý đơn đặt của khách hàng</h4>
                        </div>
                        <div class="modal-body alert alert-info" style="margin-bottom: 0px;">
                          
                            <div class="row">
                                <div class="col-12">   <strong>
      <i class="glyphicon glyphicon-info-sign"></i>
  </strong> Vui lòng nhập link bằng chứng để xác nhận</div>

                                <div class="col-lg-12" style="position: relative; min-height: 1px; padding-right: 15px; padding-left: 15px;"> <input type="text" id="linkInput-@order.OrderID" name="linkInput" placeholder="Nhập link xác minh"></div>


                            </div>
                          

                                            
                        </div>
                        <div class="modal-footer">
                                <button id="btnSucsessOrder-@order.OrderID" type="button" class="btnSucsessOrder btn btn-success"
                                        data-id="@order.OrderID"
                                        data-employeeUserName="@order.Employee.UserName"
                                        data-productName="@order.Product.ProductName"
                                        data-orderedTime="@order.OrderedTime"
                                        data-payType="@order.Type"
                                        data-textlink="@order.Textlink"
                                        data-productPrice="@order.Product.Price"
                                        data-action=""
                                        data-url="/Admin/ManageOrder/AcceptGotProduct"
                                        data-nextStatus=""
                                        data-dismiss="modal">
                                    <span class="glyphicon glyphicon-ok-sign"></span> Đồng ý
                                </button>
                            <button type="button" class="btn btn-default" data-dismiss="modal">
                                <span class="glyphicon glyphicon-remove"></span>
                                Từ chối
                            </button>
                        </div>
                    </div>
                </div>
            </div>    
            
            
            <script>

    // Bắt sự kiện khi modal được mở
$('#sucsess-@order.OrderID').on('shown.bs.modal', function () {
    // Bắt sự kiện khi nút "Đồng ý" được click
    $('#btnSucsessOrder-@order.OrderID').click(function() {
        // Lấy giá trị từ ô nhập
        var inputValue = $('#linkInput-@order.OrderID').val();

        // Biểu thức chính quy để kiểm tra link
        var regex = /\b(?:https?|ftp|file):\/\/[-A-Za-z0-9+&@@#\/%?=~_|!:,.;]*[-A-Za-z0-9+&@@#\/%=~_|]/;

        // Kiểm tra dữ liệu nhập vào với regex
        if (regex.test(inputValue)) {
            // Nếu link hợp lệ, thực hiện AJAX request
            var orderID = '@order.OrderID'; // Lấy orderID từ HTML
            var url = '/Admin/ManageOrder/AcceptGotProduct'; // Thay YOUR_API_ENDPOINT bằng endpoint của bạn



            // Dữ liệu để gửi qua AJAX request
            var data = {
                OrderID: orderID,
                linksucess: inputValue // Thay `linksucess` bằng tên trường dữ liệu của bạn
            };

            // Thực hiện AJAX request
            $.ajax({
                contentType: 'application/json',
                url: url,
                method: "POST",
                data: JSON.stringify(data),
                success: function (res) {
                    console.log('===> res: ', res);
                    filter($('#currentPage').val());
                },
                error: function (err) {
                    console.log("===> err: ", err);
                }
            });








        } else {
            // Nếu sai, hiển thị một cảnh báo
            alert("Link không hợp lệ!");
        }
    });
});



            </script>


            @*Model Process*@
            <div class="modal fade" id="process-@order.OrderID" tabindex="-1" role="dialog" aria-labelledby="edit" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content" style="border-radius: 10px;">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                                <span class="glyphicon glyphicon-remove" aria-hidden="true"></span>
                            </button>
                            <h4 class="modal-title custom_align" id="Heading">Xử lý đơn đặt của khách hàng</h4>
                        </div>
                        <div class="modal-body alert alert-info" style="margin-bottom: 0px;">
                            <strong>
                                <i class="glyphicon glyphicon-info-sign"></i>
                            </strong>
                            Bạn có chắc chắn <span class="actionNameOrder"></span> với đơn này không?
                        </div>
                        <div class="modal-footer">
                            <button id="btnProcessOrder-@order.OrderID" type="button" class="btnProcessOrder btn btn-success"
                                    data-id="@order.OrderID"
                                    data-employeeUserName="@order.Employee.UserName"
                                    data-productName="@order.Product.ProductName"
                                    data-orderedTime="@order.OrderedTime"
                                    data-payType="@order.Type"
                                    data-textlink="@order.    Textlink"
                                    data-productPrice="@order.Product.Price"
                                    data-action=""
                                    data-url=""
                                    data-nextStatus=""
                                    data-dismiss="modal">
                                <span class="glyphicon glyphicon-ok-sign"></span> Đồng ý
                            </button>
                            <button type="button" class="btn btn-default" data-dismiss="modal">
                                <span class="glyphicon glyphicon-remove"></span>
                                Từ chối
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            @*Model Delete*@
            <div class="modal fade" id="delete-@order.OrderID" tabindex="-1" role="dialog" aria-labelledby="edit" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content" style="border-radius: 10px;">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                                <span class="glyphicon glyphicon-remove" aria-hidden="true"></span>
                            </button>
                            <h4 class="modal-title custom_align" id="Heading">Xóa đơn đặt của khách hàng</h4>
                        </div>
                        <div class="alert alert-danger" style="margin-bottom: 0px;">

                            <span class="glyphicon glyphicon-exclamation-sign"></span>
                            Bạn có chắc chắn xóa vĩnh viễn đơn này không?

                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btnDeleteOrder btn btn-success"
                                    data-id="@order.OrderID"
                                    data-url="/Admin/ManageOrder/Delete"
                                    data-dismiss="modal">
                                <span class="glyphicon glyphicon-ok-sign"></span>
                                Đồng ý
                            </button>
                            <button type="button" class="btn btn-default" data-dismiss="modal">
                                <span class="glyphicon glyphicon-remove"></span>
                                Từ chối
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        }
    </tbody>
</table>



<div class="clearfix"></div>

<ul class="pagination" style="display: flex; justify-content: center; align-items: center;">
    <li id="btnPrev">
        <a href="#"><span class="glyphicon glyphicon-chevron-left"></span></a>
    </li>
    <li>
        <input id="currentPage" class="input-sm" 
               style="max-width: 55px; outline: none; border: 1px solid #ddd; height: 34px;" 
               type="number" min="1" 
               value="@Model.CurrentPage" />
    </li>
    <li>
        <span>/</span>
    </li>
    <li>
        <span>@Model.TotalPage trang</span>
    </li>
    <li id="btnNext">
        <a href="#"><span class="glyphicon glyphicon-chevron-right"></span></a>
    </li>
</ul>
